{
    "rules": {
        "status": {
            "$userId": {
                ".read": "auth != null",
                ".write": "auth != null && auth.uid == $userId"
            }
        },
        "user_chats": {
            "$userId": {
                ".read": "auth != null && auth.uid == $userId",
                "$chatId": {
                    "lastUpdated": {
                        ".write": "auth != null && auth.uid == $userId",
                        ".validate": "newData.isNumber()"
                    }
                }
            }
        },
        "chats": {
            "$chatId": {
                ".read": "auth != null && (auth.token.isAdmin === true || auth.token.superAdmin === true || root.child('user_chats').child(auth.uid).child($chatId).exists() || $chatId === 'gemini_' + auth.uid || ($chatId.contains('_') && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))))",
                "meta": {
                    ".write": "auth != null && (auth.token.isAdmin === true || auth.token.superAdmin === true || root.child('user_chats').child(auth.uid).child($chatId).exists() || ($chatId.contains('_') && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))))",
                    "lastMessage": {
                        ".write": "auth != null && newData.child('senderId').val() === auth.uid",
                        ".validate": "newData.hasChildren(['text', 'senderId', 'timestamp'])"
                    },
                    "unreadCount": {
                        "$uid": {
                            ".write": "auth != null && auth.uid == $uid",
                            ".validate": "newData.val() == 0"
                        }
                    }
                },
                "typing": {
                    "$userId": {
                        ".write": "auth != null && (auth.uid == $userId || auth.token.isAdmin === true || auth.token.superAdmin === true || ($chatId.contains('_') && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))))",
                        ".validate": "newData.isNumber() || newData.val() == null"
                    }
                },
                "signals": {
                    "$messageId": {
                        ".write": "auth != null && (auth.token.isAdmin === true || auth.token.superAdmin === true || root.child('user_chats').child(auth.uid).child($chatId).exists() || $chatId === 'gemini_' + auth.uid || ($chatId.contains('_') && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))))",
                        ".validate": "newData.hasChildren(['s', 'ts'])"
                    }
                },
                "status": {
                    "$messageId": {
                        ".write": "auth != null && (auth.token.isAdmin === true || auth.token.superAdmin === true || root.child('user_chats').child(auth.uid).child($chatId).exists() || $chatId === 'gemini_' + auth.uid || ($chatId.contains('_') && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))))"
                    }
                }
            }
        },
        "calls": {
            "$callId": {
                ".read": "auth != null && (data.child('callerId').val() === auth.uid || data.child('receiverId').val() === auth.uid || auth.token.isAdmin === true)",
                ".write": "auth != null && ((!data.exists() && newData.child('callerId').val() === auth.uid) || (data.child('callerId').val() === auth.uid || data.child('receiverId').val() === auth.uid))",
                ".validate": "newData.hasChildren(['callerId', 'receiverId'])"
            }
        }
    }
}